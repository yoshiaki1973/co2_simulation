<!DOCTYPE html>
<html>
<head>
    <title>Chart.js 資材算定 CO2排出量シミュレーション</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        .chart-section { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
        #pieChartContainer, #barChartContainer {
            flex: 1; max-width: 48%; min-width: 350px; margin: 10px;
            background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        @media (max-width: 768px) { #pieChartContainer, #barChartContainer { max-width: 95%; } }

        #totalAmountDisplay { text-align: center; font-size: 1.5em; font-weight: bold; margin-top: 15px; color: #34495e; }
        #comparisonDisplay { text-align: center; margin-top: 10px; font-size: 1.1em; color: #555; }
        #barChartComparisonDisplay { text-align: center; margin-top: 10px; font-size: 1.1em; color: #555; }
        .comparison-label { font-weight: normal; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.95em; }
        th { background-color: #eaf2f8; color: #2c3e50; }
        td input[type="number"] { width: 90%; padding: 8px; border: 1px solid #b0c4de; border-radius: 4px; box-sizing: border-box; }
        .total-row { font-weight: bold; background-color: #d6eaf8; color: #2c3e50; }
        .amount-cell { font-weight: bold; text-align: right; }
        .estimate-item-link { cursor: pointer; color: #007bff; text-decoration: underline; margin-right: 5px; }
        .estimate-item-link:hover { color: #0056b3; }
        #showInitialChartButton {
            display: block; margin: 20px auto 10px auto; padding: 10px 20px;
            background-color: #6c757d; color: white; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color 0.3s ease;
        }
        #showInitialChartButton:hover { background-color: #5a6268; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
        }
        #detailModal .modal-content { margin: 2% auto; max-width: 900px; }
        #alternativeModal .modal-content { max-width: 900px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .modal-content th, .modal-content td {
            border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em;
        }
        .modal-content th { background-color: #f2f2f2; }
        /* 資材別CO2排出内訳画面の原単位、数量、排出量を右寄せ */
        /* 単位の位置変更に伴い、セレクタも修正 */
        .modal-content th:nth-child(3),
        .modal-content td:nth-child(3), /* 原単位 */
        .modal-content th:nth-child(4),
        .modal-content td:nth-child(4), /* 数量 */
        .modal-content th:nth-child(6),
        .modal-content td:nth-child(6) { /* 排出量 */
            text-align: right;
        }


        #alternativeList tbody tr { cursor: pointer; }
        #alternativeList tbody tr:hover { background-color: #f0f0f0; }
        .alt-price-cell { text-align: right; }

        .modal-content .modal-button {
            display: block; margin: 10px auto; padding: 10px 20px; color: white; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color 0.3s ease;
        }
        .modal-content #updateChartButton { background-color: #28a745; }
        .modal-content #updateChartButton:hover { background-color: #218838; }

        #historyDisplayArea {
            margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 98%; margin-left: auto; margin-right: auto; box-sizing: border-box;
        }
        #historyDisplayArea h2 { margin-top: 0; margin-bottom: 15px; text-align: left; color: #2c3e50; }
        #historyDisplayArea .history-content {
            max-height: 250px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px; background-color: #fdfdfd;
        }
        #historyDisplayArea table { width: 100%; border-collapse: collapse; }
        #historyDisplayArea th, #historyDisplayArea td {
            border: 1px solid #ddd;
            padding: 4px; /* パディングを減らす */
            text-align: left; /* デフォルトを左寄せに変更 */
            font-size: 0.75em; /* フォントサイズを小さくする */
            vertical-align: middle;
        }
        #historyDisplayArea th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 1;
            white-space: nowrap; /* ヘッダーのテキストを折り返さない */
        }
        /* 各列の幅と寄せを調整 */
        #historyDisplayArea th:nth-child(1), #historyDisplayArea td:nth-child(1) { /* 変更番号 */
            width: 5%;
            text-align: center;
        }
        #historyDisplayArea th:nth-child(2), #historyDisplayArea td:nth-child(2) { /* 工程 */
            width: 10%;
        }
        #historyDisplayArea th:nth-child(3), #historyDisplayArea td:nth-child(3), /* 見積項目 (変更前) */
        #historyDisplayArea th:nth-child(4), #historyDisplayArea td:nth-child(4) { /* 見積項目 (変更後) */
            width: 10%;
        }
        #historyDisplayArea th:nth-child(5), #historyDisplayArea td:nth-child(5), /* 資材名 (変更前) */
        #historyDisplayArea th:nth-child(6), #historyDisplayArea td:nth-child(6) { /* 資材名 (変更後) */
            width: 15%;
        }
        #historyDisplayArea th:nth-child(7), #historyDisplayArea td:nth-child(7), /* 原単位 (変更前) */
        #historyDisplayArea th:nth-child(8), #historyDisplayArea td:nth-child(8) { /* 原単位 (変更後) */
            width: 9%;
            text-align: right;
        }
        #historyDisplayArea th:nth-child(9), #historyDisplayArea td:nth-child(9), /* 数量 (変更前) */
        #historyDisplayArea th:nth-child(10), #historyDisplayArea td:nth-child(10) { /* 数量 (変更後) */
            width: 9%;
            text-align: right;
        }
        #historyDisplayArea th:nth-child(11), #historyDisplayArea td:nth-child(11), /* 排出量 (変更前) */
        #historyDisplayArea th:nth-child(12), #historyDisplayArea td:nth-child(12) { /* 排出量 (変更後) */
            width: 9%;
            text-align: right;
        }

        /* 履歴テーブルの2行表示のためのスタイル */
        #historyDisplayArea td > div {
            display: flex;
            flex-direction: column-reverse;
            justify-content: center;
            align-items: flex-start;
            height: 100%;
        }
        /* 右寄せが必要なセル内のdivは個別に設定 */
        #historyDisplayArea td:nth-child(1) > div, /* 変更番号 */
        #historyDisplayArea td:nth-child(7) > div,
        #historyDisplayArea td:nth-child(8) > div,
        #historyDisplayArea td:nth-child(9) > div,
        #historyDisplayArea td:nth-child(10) > div,
        #historyDisplayArea td:nth-child(11) > div,
        #historyDisplayArea td:nth-child(12) > div {
            align-items: flex-end; /* 右寄せにする */
        }
        #historyDisplayArea td:nth-child(1) > div { /* 変更番号のテキストを中央揃えに */
            align-items: center;
        }


        #historyDisplayArea td div > span {
            white-space: nowrap; /* テキストの折り返しを防ぐ */
            overflow: hidden;    /* はみ出した部分を隠す */
            text-overflow: ellipsis; /* はみ出した部分を...で表示 */
            max-width: 100%;     /* 親要素の幅に合わせる */
            box-sizing: border-box; /* paddingを含めて幅を計算 */
            padding: 2px 0; /* 少しパディングを追加 */
        }
        #historyDisplayArea td div span.current-value {
            font-weight: bold; /* 変更後を太字にする */
            color: #007bff; /* 変更後の色を青にする */
        }
        #historyDisplayArea td div span.previous-value {
            color: #555; /* 変更前の色をグレーにする */
        }


        #comparisonChartModal .modal-content { max-width: 1200px; width: 95%; }
        .chart-comparison-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .chart-comparison-item {
            flex: 1; min-width: 450px; max-width: 550px; background-color: #fff;
            padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); box-sizing: border-box;
        }
        .chart-comparison-item h4 { text-align: center; margin-top: 0; color: #333; }
    </style>
</head>
<body>
    <h1>資材算定 CO2排出量シミュレーション</h1>

    <div class="chart-section">
        <div id="pieChartContainer">
            <canvas id="pieChartCanvas"></canvas>
            <div id="totalAmountDisplay">
                総CO2排出量: <span id="globalTotalAmount">0 kg-CO2</span>
            </div>
            <div id="comparisonDisplay">
                <span class="comparison-label">変更前合計: </span><span id="initialGlobalTotalAmount">0 kg-CO2</span>
                <span class="comparison-label"> / 差額: </span><span id="diffAmount">0 kg-CO2</span>
                <span class="comparison-label"> / 増減率: </span><span id="percentageChange">0.00%</span>
            </div>
        </div>

        <div id="barChartContainer">
            <canvas id="barChartCanvas"></canvas>
            <div id="barChartComparisonDisplay">
                <span class="comparison-label">変更前合計: </span><span id="barInitialTotalAmount">0 kg-CO2</span>
                <span class="comparison-label"> / 差額: </span><span id="barDiffAmount">0 kg-CO2</span>
                <span class="comparison-label"> / 増減率: </span><span id="barPercentageChange">0.00%</span>
            </div>
        </div>
    </div>

    <div id="historyDisplayArea">
        <h2>変更内容</h2>
        <div class="history-content">
            <p>ここに資材の変更内容が表示されます。</p>
        </div>
    </div>

    <button id="showInitialChartButton">変更前/変更後グラフ比較</button>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDetailModal">&times;</span>
            <h3 id="detailModalHeader">資材別CO2排出内訳</h3>
            <div id="detailModalBody">
                <p>円グラフのセグメントをクリックすると、詳細な構成要素が表示されます。資材の使用量を変更したり、資材名をクリックして代替資材を選択した後、「グラフを全て更新」ボタンを押してください。</p>
            </div>
            <button id="updateChartButton" class="modal-button">グラフを全て更新</button>
        </div>
    </div>

    <div id="alternativeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAlternativeModal">&times;</span>
            <h3 id="modalEstimateItemTitle">代替見積項目を選択</h3>
            <div id="alternativeList">
            </div>
        </div>
    </div>

    <div id="comparisonChartModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeComparisonChartModal">&times;</span>
            <h2>CO2排出量比較</h2>
            <div class="chart-comparison-container">
                <div class="chart-comparison-item">
                    <h4>変更前</h4>
                    <canvas id="initialPieChartCanvas"></canvas>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold;">
                        合計: <span id="initialModalTotal">0 kg-CO2</span>
                    </div>
                </div>
                <div class="chart-comparison-item">
                    <h4>変更後</h4>
                    <canvas id="currentPieChartCanvas"></canvas>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold;">
                        合計: <span id="currentModalTotal">0 kg-CO2</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pieChartLabels = [
            '直接仮設', '土', '杭・基礎', 'コンクリート', 'PCコンクリート躯体', '鉄骨', '鉄筋', '屋根'
        ];
        let pieChartDataValues = [];
        let initialPieChartDataValues = [];

        const pieChartBackgroundColors = [
            'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
            'rgba(199, 255, 132, 0.8)', 'rgba(132, 255, 217, 0.8)'
        ];
        const hoverOffset = 20;

        const initialDetailData = new Map();

        initialDetailData.set('コンクリート', new Map([
            ['デッキ床コンクリート', { estimateItem: 'スラブA', unitPrice: 350, quantity: 2.2, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc27N' }],
            ['基礎コンクリート', { estimateItem: '基礎A', unitPrice: 300, quantity: 1.2, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc21N' }],
            ['2F床コンクリート', { estimateItem: 'スラブB', unitPrice: 300, quantity: 0.7, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc21N' }],
            ['ドック棟コンクリート', { estimateItem: '躯体A', unitPrice: 284, quantity: 0.4, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc18N' }],
            ['捨てコンクリート', { estimateItem: '均しコンクリート', unitPrice: 284, quantity: 0.1, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc18N' }],
            ['基礎コンクリートB', { estimateItem: '基礎B', unitPrice: 310, quantity: 0.8, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc24N' }],
            ['基礎コンクリートC', { estimateItem: '基礎C', unitPrice: 290, quantity: 0.5, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc18N' }],
            ['躯体コンクリートB', { estimateItem: '躯体B', unitPrice: 290, quantity: 0.6, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc21N' }],
            ['躯体コンクリートC', { estimateItem: '躯体C', unitPrice: 270, quantity: 0.3, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc15N' }],
            ['スラブコンクリートC', { estimateItem: 'スラブC', unitPrice: 320, quantity: 1.5, unit: 'm³', currentAltName: 'コンクリート(ポルトランド) Fc30N' }]
        ]));

        initialDetailData.set('直接仮設', new Map([
            ['仮設材A', { estimateItem: '仮設材A', unitPrice: 0.1, quantity: 1500, unit: '個', currentAltName: '標準仮設材A' }],
            ['仮設材B', { estimateItem: '仮設材B', unitPrice: 0.12, quantity: 800, unit: '個', currentAltName: '標準仮設材B' }],
            ['仮設材C', { estimateItem: '仮設材C', unitPrice: 0.08, quantity: 2000, unit: '個', currentAltName: '標準仮設材C' }]
        ]));
        initialDetailData.set('土', new Map([
            ['土工A', { estimateItem: '土工A', unitPrice: 0.05, quantity: 2000, unit: 'm³', currentAltName: '標準土' }],
            ['土工B', { estimateItem: '土工B', unitPrice: 0.06, quantity: 1000, unit: 'm³', currentAltName: '高密度土' }],
            ['土工C', { estimateItem: '土工C', unitPrice: 0.04, quantity: 3000, unit: 'm³', currentAltName: '軽量土' }]
        ]));
        initialDetailData.set('杭・基礎', new Map([
            ['杭材A', { estimateItem: '杭A', unitPrice: 0.2, quantity: 800, unit: '本', currentAltName: '標準杭材A' }],
            ['杭材B', { estimateItem: '杭B', unitPrice: 0.22, quantity: 500, unit: '本', currentAltName: '高強度杭材B' }],
            ['杭材C', { estimateItem: '杭C', unitPrice: 0.18, quantity: 1000, unit: '本', currentAltName: '軽量杭材C' }]
        ]));
        initialDetailData.set('PCコンクリート躯体', new Map([
            ['PC部材A', { estimateItem: '躯体A', unitPrice: 0.4, quantity: 700, unit: '個', currentAltName: '標準PC部材A' }],
            ['PC部材B', { estimateItem: '躯体B', unitPrice: 0.45, quantity: 400, unit: '個', currentAltName: '高強度PC部材B' }],
            ['PC部材C', { estimateItem: '躯体C', unitPrice: 0.38, quantity: 900, unit: '個', currentAltName: '軽量PC部材C' }]
        ]));
        initialDetailData.set('鉄骨', new Map([
            ['鉄骨材A', { estimateItem: '鉄骨A', unitPrice: 1.5, quantity: 300, unit: 'トン', currentAltName: '標準鉄骨材A' }],
            ['鉄骨材B', { estimateItem: '鉄骨B', unitPrice: 1.6, quantity: 200, unit: 'トン', currentAltName: '高張力鉄骨材B' }],
            ['鉄骨材C', { estimateItem: '鉄骨C', unitPrice: 1.4, quantity: 400, unit: 'トン', currentAltName: '軽量鉄骨材C' }]
        ]));
        initialDetailData.set('鉄筋', new Map([
            ['鉄筋材A', { estimateItem: '鉄筋A', unitPrice: 1.0, quantity: 500, unit: 'トン', currentAltName: '標準鉄筋材A' }],
            ['鉄筋材B', { estimateItem: '鉄筋B', unitPrice: 1.1, quantity: 300, unit: 'トン', currentAltName: '高強度鉄筋材B' }],
            ['鉄筋材C', { estimateItem: '鉄筋C', unitPrice: 0.9, quantity: 600, unit: 'トン', currentAltName: '再生鉄筋材C' }]
        ]));
        initialDetailData.set('屋根', new Map([
            ['屋根材A', { estimateItem: '屋根A', unitPrice: 0.25, quantity: 1200, unit: 'm²', currentAltName: '標準屋根材A' }],
            ['屋根材B', { estimateItem: '屋根B', unitPrice: 0.28, quantity: 800, unit: 'm²', currentAltName: '軽量屋根材B' }],
            ['屋根材C', { estimateItem: '屋根C', unitPrice: 0.22, quantity: 1500, unit: 'm²', currentAltName: '断熱屋根材C' }]
        ]));

        const alternativeComponentsData = new Map();

        alternativeComponentsData.set('スラブA', [
            { altEstimateItemName: '高炉セメントスラブA', materials: [{ name: '高炉セメントA種 Fc27N', unitPrice: 300, quantity: 2.2, unit: 'm³' }] },
            { altEstimateItemName: '低炭素コンクリートスラブA', materials: [{ name: '低炭素型コンクリートAA Fc27N', unitPrice: 280, quantity: 2.2, unit: 'm³' }] },
            { altEstimateItemName: '再生骨材スラブA', materials: [{ name: '再生骨材コンクリート Fc27N', unitPrice: 320, quantity: 2.2, unit: 'm³' }] },
            { altEstimateItemName: 'フライアッシュスラブA', materials: [{ name: 'フライアッシュコンクリート Fc27N', unitPrice: 290, quantity: 2.2, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('基礎A', [
            { altEstimateItemName: '高炉セメント基礎A', materials: [{ name: '高炉セメントB種 Fc21N', unitPrice: 260, quantity: 1.2, unit: 'm³' }] },
            { altEstimateItemName: '低炭素コンクリート基礎A', materials: [{ name: '低炭素型コンクリートXX Fc21N', unitPrice: 240, quantity: 1.2, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('スラブB', [
            { altEstimateItemName: '軽量骨材スラブB', materials: [{ name: '軽量骨材コンクリート Fc21N', unitPrice: 280, quantity: 0.7, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('躯体A', [
            { altEstimateItemName: '高炉セメント躯体A', materials: [{ name: '高炉セメントA種 Fc18N', unitPrice: 257, quantity: 0.4, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('均しコンクリート', [
            { altEstimateItemName: '再生骨材均しコン', materials: [{ name: '石膏ボード再生骨材コンクリート Fc18N', unitPrice: 270, quantity: 0.1, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('基礎B', [
            { altEstimateItemName: 'エコベース基礎B', materials: [{ name: 'エコベースコンクリート Fc24N', unitPrice: 280, quantity: 0.8, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('基礎C', [
            { altEstimateItemName: 'ジオポリマー基礎C', materials: [{ name: 'ジオポリマーコンクリート Fc18N', unitPrice: 250, quantity: 0.5, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('躯体B', [
            { altEstimateItemName: '低炭素PC躯体B', materials: [{ name: '低炭素PCコンクリート Fc21N', unitPrice: 270, quantity: 0.6, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('躯体C', [
            { altEstimateItemName: '再生コンクリート躯体C', materials: [{ name: '再生骨材コンクリート Fc15N', unitPrice: 240, quantity: 0.3, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('スラブC', [
            { altEstimateItemName: '高耐久スラブC', materials: [{ name: '高耐久コンクリート Fc30N', unitPrice: 300, quantity: 1.5, unit: 'm³' }] }
        ]);


        alternativeComponentsData.set('仮設材A', [
            { altEstimateItemName: '軽量仮設材A', materials: [{ name: '軽量仮設材A', unitPrice: 0.08, quantity: 1500, unit: '個' }] },
            { altEstimateItemName: '再利用仮設材A', materials: [{ name: '再利用仮設材A', unitPrice: 0.07, quantity: 1500, unit: '個' }] }
        ]);
        alternativeComponentsData.set('仮設材B', [
            { altEstimateItemName: '省エネ仮設材B', materials: [{ name: '省エネ仮設材B', unitPrice: 0.1, quantity: 800, unit: '個' }] }
        ]);
        alternativeComponentsData.set('仮設材C', [
            { altEstimateItemName: '低コスト仮設材C', materials: [{ name: '低コスト仮設材C', unitPrice: 0.07, quantity: 2000, unit: '個' }] }
        ]);

        alternativeComponentsData.set('土工A', [
            { altEstimateItemName: '現地発生土再利用A', materials: [{ name: '現地発生土再利用', unitPrice: 0.02, quantity: 2000, unit: 'm³' }] },
            { altEstimateItemName: '改良土工A', materials: [{ name: '改良土A', unitPrice: 0.03, quantity: 2000, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('土工B', [
            { altEstimateItemName: 'バイオ土工B', materials: [{ name: 'バイオ安定土B', unitPrice: 0.04, quantity: 1000, unit: 'm³' }] }
        ]);
        alternativeComponentsData.set('土工C', [
            { altEstimateItemName: '軽量盛土材C', materials: [{ name: '軽量盛土材C', unitPrice: 0.03, quantity: 3000, unit: 'm³' }] }
        ]);

        alternativeComponentsData.set('杭A', [
            { altEstimateItemName: '低炭素鋼杭A', materials: [{ name: '低炭素鋼杭A', unitPrice: 0.18, quantity: 800, unit: '本' }] },
            { altEstimateItemName: '再生材杭A', materials: [{ name: '再生材杭A', unitPrice: 0.17, quantity: 800, unit: '本' }] }
        ]);
        alternativeComponentsData.set('杭B', [
            { altEstimateItemName: '高強度杭B', materials: [{ name: '高強度杭B', unitPrice: 0.2, quantity: 500, unit: '本' }] }
        ]);
        alternativeComponentsData.set('杭C', [
            { altEstimateItemName: 'エコパイル杭C', materials: [{ name: 'エコパイル杭C', unitPrice: 0.16, quantity: 1000, unit: '本' }] }
        ]);

        alternativeComponentsData.set('躯体A', [
            { altEstimateItemName: '高強度PC部材A', materials: [{ name: '高強度PC部材A', unitPrice: 0.35, quantity: 700, unit: '個' }] },
            { altEstimateItemName: '軽量PC部材A', materials: [{ name: '軽量PC部材A', unitPrice: 0.38, quantity: 700, unit: '個' }] }
        ]);
        alternativeComponentsData.set('躯体B', [
            { altEstimateItemName: 'プレキャスト躯体B', materials: [{ name: 'プレキャスト躯体B', unitPrice: 0.42, quantity: 400, unit: '個' }] }
        ]);
        alternativeComponentsData.set('躯体C', [
            { altEstimateItemName: '再利用PC部材C', materials: [{ name: '再利用PC部材C', unitPrice: 0.36, quantity: 900, unit: '個' }] }
        ]);

        alternativeComponentsData.set('鉄骨A', [
            { altEstimateItemName: '高張力鋼鉄骨A', materials: [{ name: '高張力鋼材A', unitPrice: 1.3, quantity: 300, unit: 'トン' }] },
            { altEstimateItemName: '再生鉄骨A', materials: [{ name: '再生鉄骨材A', unitPrice: 1.25, quantity: 300, unit: 'トン' }] }
        ]);
        alternativeComponentsData.set('鉄骨B', [
            { altEstimateItemName: '軽量鉄骨B', materials: [{ name: '軽量鉄骨材B', unitPrice: 1.4, quantity: 200, unit: 'トン' }] }
        ]);
        alternativeComponentsData.set('鉄骨C', [
            { altEstimateItemName: '環境配慮鉄骨C', materials: [{ name: '環境配慮型鉄骨C', unitPrice: 1.35, quantity: 400, unit: 'トン' }] }
        ]);

        alternativeComponentsData.set('鉄筋A', [
            { altEstimateItemName: '高強度鉄筋A', materials: [{ name: '高強度鉄筋材A', unitPrice: 0.9, quantity: 500, unit: 'トン' }] },
            { altEstimateItemName: '低炭素鉄筋A', materials: [{ name: '低炭素鉄筋材A', unitPrice: 0.85, quantity: 500, unit: 'トン' }] }
        ]);
        alternativeComponentsData.set('鉄筋B', [
            { altEstimateItemName: '防錆鉄筋B', materials: [{ name: '防錆鉄筋材B', unitPrice: 1.05, quantity: 300, unit: 'トン' }] }
        ]);
        alternativeComponentsData.set('鉄筋C', [
            { altEstimateItemName: 'エコ鉄筋C', materials: [{ name: 'エコ鉄筋材C', unitPrice: 0.8, quantity: 600, unit: 'トン' }] }
        ]);

        alternativeComponentsData.set('屋根A', [
            { altEstimateItemName: '太陽光一体型屋根A', materials: [{ name: '太陽光発電一体型屋根材A', unitPrice: 0.2, quantity: 1200, unit: 'm²' }] },
            { altEstimateItemName: '高断熱屋根A', materials: [{ name: '高断熱屋根材A', unitPrice: 0.23, quantity: 1200, unit: 'm²' }] }
        ]);
        alternativeComponentsData.set('屋根B', [
            { altEstimateItemName: '緑化屋根B', materials: [{ name: '緑化屋根材B', unitPrice: 0.26, quantity: 800, unit: 'm²' }] }
        ]);
        alternativeComponentsData.set('屋根C', [
            { altEstimateItemName: '長寿命屋根C', materials: [{ name: '長寿命屋根材C', unitPrice: 0.2, quantity: 1500, unit: 'm²' }] }
        ]);


        function deepCopyMap(originalMap) {
            const newMap = new Map();
            originalMap.forEach((value, key) => {
                if (value instanceof Map) {
                    newMap.set(key, deepCopyMap(value));
                } else if (typeof value === 'object' && value !== null) {
                    newMap.set(key, { ...value });
                } else {
                    newMap.set(key, value);
                }
            });
            return newMap;
        }

        const detailData = deepCopyMap(initialDetailData);
        let globalChangeLog = []; // 変更履歴を格納する配列

        let pieChart;
        let barChart;
        let initialModalPieChart;
        let currentModalPieChart;

        let currentSelectedRegion = null;
        let currentSelectedEstimateItemData = null; // クリックされた資材データ（detailData内の参照）
        let currentOriginalEstimateItemName = null; // その資材の元々の見積項目名（代替候補検索用）
        let currentOriginalProductData = null; // 元々の資材のデータ（initialDetailDataから取得）
        let currentProductNameKey = null; // 現在選択中の資材のキー（例: 'デッキ床コンクリート'）

        let initialGlobalTotalAmount = 0;

        function calculatePieChartData() {
            pieChartDataValues = pieChartLabels.map(region => {
                const products = detailData.get(region);
                if (products) {
                    return Array.from(products.values()).reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
                }
                return 0;
            });
        }

        function calculateInitialPieChartData() {
            initialPieChartDataValues = pieChartLabels.map(region => {
                const products = initialDetailData.get(region);
                if (products) {
                    return Array.from(products.values()).reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
                }
                return 0;
            });
        }

        function updateGlobalTotalAmount() {
            const currentGlobalTotal = pieChartDataValues.reduce((sum, value) => sum + value, 0);
            document.getElementById('globalTotalAmount').innerText = currentGlobalTotal.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' kg-CO2';
            updateComparisonDisplay(currentGlobalTotal, 'pie');
            updateComparisonDisplay(currentGlobalTotal, 'bar');
        }

        function updateComparisonDisplay(currentTotal, targetChart) {
            const initialTotalId = (targetChart === 'pie') ? 'initialGlobalTotalAmount' : 'barInitialTotalAmount';
            const diffAmountId = (targetChart === 'pie') ? 'diffAmount' : 'barDiffAmount';
            const percentageChangeId = (targetChart === 'pie') ? 'percentageChange' : 'barPercentageChange';

            const diffAmountElement = document.getElementById(diffAmountId);
            const percentageChangeElement = document.getElementById(percentageChangeId);
            const initialTotalElement = document.getElementById(initialTotalId);

            const diff = currentTotal - initialGlobalTotalAmount;
            const percentage = (initialGlobalTotalAmount === 0) ? 0 : (diff / initialGlobalTotalAmount) * 100;

            initialTotalElement.innerText = initialGlobalTotalAmount.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' kg-CO2';

            let diffText = '';
            if (diff > 0) {
                diffText = `+${diff.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2`;
                diffAmountElement.className = 'positive';
            } else if (diff < 0) {
                diffText = `${diff.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2`;
                diffAmountElement.className = 'negative';
            } else {
                diffText = `0 kg-CO2`;
                diffAmountElement.className = '';
            }
            diffAmountElement.innerText = diffText;

            let percentageText = '';
            if (percentage > 0) {
                percentageText = `+${percentage.toFixed(2)}%`;
                percentageChangeElement.className = 'positive';
            } else if (percentage < 0) {
                percentageText = `${percentage.toFixed(2)}%`;
                percentageChangeElement.className = 'negative';
            } else {
                percentageText = `0.00%`;
                percentageChangeElement.className = '';
            }
            percentageChangeElement.innerText = percentageText;
        }

        function drawPieChart() {
            calculatePieChartData();
            const ctx = document.getElementById('pieChartCanvas').getContext('2d');
            if (pieChart) { pieChart.destroy(); }
            Chart.register(ChartDataLabels);
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: pieChartLabels,
                    datasets: [{
                        data: pieChartDataValues,
                        backgroundColor: pieChartBackgroundColors,
                        hoverOffset: hoverOffset,
                        datalabels: {
                            color: '#fff', font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                                const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                return `${percentage}%`;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'CO2排出量（変更後）', font: { size: 24, family: 'Arial' }, padding: { top: 10, bottom: 20 } },
                        legend: { position: 'right', labels: { font: { size: 14 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2 (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const clickedElement = elements[0];
                            const index = clickedElement.index;
                            currentSelectedRegion = pieChartLabels[index];
                            displayDetailTable(currentSelectedRegion);
                            document.getElementById('detailModal').style.display = 'block';
                        }
                    }
                }
            });
            updateGlobalTotalAmount();
        }

        function drawBarChart(initialTotal, currentTotal) {
            const ctx = document.getElementById('barChartCanvas').getContext('2d');
            if (barChart) { barChart.destroy(); }
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['変更前合計', '変更後合計'],
                    datasets: [{
                        label: 'CO2排出量',
                        data: [initialTotal, currentTotal],
                        backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: '総CO2排出量の比較', font: { size: 20 } },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.label}: ${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'CO2排出量 (kg-CO2)' },
                            ticks: {
                                callback: function(value) { return value.toLocaleString() + ' kg-CO2'; }
                            }
                        }
                    }
                }
            });
        }

        const detailModal = document.getElementById('detailModal');
        const closeDetailModalButton = document.getElementById('closeDetailModal');
        const detailModalHeader = document.getElementById('detailModalHeader');
        const detailModalBody = document.getElementById('detailModalBody');
        const updateChartButton = document.getElementById('updateChartButton');

        detailModalBody.addEventListener('change', (event) => {
            if (event.target.matches('input[type="number"]')) {
                handleQuantityChange(event);
            }
        });

        detailModalBody.addEventListener('input', (event) => {
            if (event.target.matches('input[type="number"]')) {
                handleQuantityChange(event);
            }
        });

        detailModalBody.addEventListener('click', (event) => {
            const linkElement = event.target.closest('.estimate-item-link');
            if (linkElement) {
                handleEstimateItemClick(linkElement);
            }
        });

        function displayDetailTable(region) {
            console.log(`[displayDetailTable] Displaying details for region: ${region}`);
            const products = detailData.get(region);

            if (products) {
                detailModalHeader.innerText = `${region}の資材別CO2排出内訳`;
                // ヘッダーの順序を変更
                let tableHtml = '<table><thead><tr><th>見積項目</th><th>資材</th><th>原単位<br>(kg-CO2/単位)</th><th>数量</th><th>単位</th><th>排出量<br>(kg-CO2)</th></tr></thead><tbody>';
                let totalAmount = 0;

                // Mapの順序を維持するために entries() を使用
                for (const [productName, item] of products.entries()) {
                    const currentAmount = item.unitPrice * item.quantity;
                    tableHtml += `<tr>
                                    <td>
                                        <span class="estimate-item-link"
                                              data-region="${region}"
                                              data-product="${productName}"
                                              data-original-estimate-item="${initialDetailData.get(region).get(productName).estimateItem}"
                                              data-original-product-name="${productName}">
                                            ${item.estimateItem || 'N/A'}
                                        </span>
                                    </td>
                                    <td>${item.currentAltName}</td>
                                    <td id="unitPrice-${productName}">${item.unitPrice.toLocaleString(undefined, { maximumFractionDigits: 3 })}</td>
                                    <td><input type="number" data-product="${productName}" value="${item.quantity}" min="0" step="0.01"></td>
                                    <td>${item.unit}</td>
                                    <td class="amount-cell" id="amount-${productName}">${currentAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                                  </tr>`;
                    totalAmount += currentAmount;
                }

                tableHtml += `<tr class="total-row">
                                <td colspan="5">合計</td>
                                <td id="regionTotal" class="amount-cell">${totalAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2</td>
                              </tr>`;
                tableHtml += '</tbody></table>';
                detailModalBody.innerHTML = tableHtml;

            } else {
                detailModalHeader.innerText = '詳細データはありません。';
                detailModalBody.innerHTML = '<p>円グラフのセグメントをクリックすると、詳細な構成要素が表示されます。資材の使用量を変更したり、資材名をクリックして代替資材を選択した後、「グラフを全て更新」ボタンを押してください。</p>';
            }
        }

        function handleQuantityChange(event) {
            const inputElement = event.target;
            const productNameKey = inputElement.dataset.product; // Mapのキーとして使用される'デッキ床コンクリート'など
            const newQuantity = parseFloat(inputElement.value);

            if (!currentSelectedRegion) {
                console.error('[handleQuantityChange] currentSelectedRegion is null. Aborting.');
                return;
            }

            const productsInRegion = detailData.get(currentSelectedRegion);
            if (!productsInRegion) {
                console.error(`[handleQuantityChange] No products found for region: ${currentSelectedRegion}. Aborting.`);
                return;
            }

            const productData = productsInRegion.get(productNameKey);
            // オリジナルデータから「変更前」の情報を取得
            const originalProductData = initialDetailData.get(currentSelectedRegion).get(productNameKey);

            if (isNaN(newQuantity) || newQuantity < 0) {
                alert('有効な数値を入力してください。');
                inputElement.value = productData.quantity; // 元の値に戻す
                return;
            }

            // 変更前の情報を記録 (常にoriginalProductDataから取得)
            const previousInfo = {
                estimateItem: originalProductData.estimateItem, // 見積項目も追加
                name: originalProductData.currentAltName,
                unitPrice: originalProductData.unitPrice,
                quantity: originalProductData.quantity,
                unit: originalProductData.unit,
                amount: originalProductData.unitPrice * originalProductData.quantity // オリジナルの排出量
            };

            // quantity を更新
            productData.quantity = newQuantity;

            // 同じregionとoriginalProductNameKeyを持つ既存の履歴を削除
            globalChangeLog = globalChangeLog.filter(log =>
                !(log.region === currentSelectedRegion && log.originalProductNameKey === productNameKey)
            );

            // グローバルな変更履歴に追加 (数量変更)
            globalChangeLog.push({
                timestamp: new Date().toLocaleString(), // 日時を記録 (表示はしないがデータとして保持)
                type: 'quantity_change', // 変更の種類 (表示はしないがデータとして保持)
                region: currentSelectedRegion,
                originalProductNameKey: productNameKey, // 履歴追跡のために元のプロダクトキーを保持
                previousEstimateItem: previousInfo.estimateItem,
                previousProductName: previousInfo.name,
                previousUnitPrice: previousInfo.unitPrice,
                previousQuantity: previousInfo.quantity,
                previousUnit: previousInfo.unit,
                previousAmount: previousInfo.amount, // 変更前の排出量
                currentEstimateItem: productData.estimateItem, // 見積項目も追加
                currentProductName: productData.currentAltName,
                currentUnitPrice: productData.unitPrice,
                currentQuantity: productData.quantity,
                currentUnit: productData.unit,
                currentAmount: productData.unitPrice * productData.quantity // 変更後の排出量
            });

            const newAmount = productData.unitPrice * productData.quantity;
            document.getElementById(`amount-${productNameKey}`).innerText = newAmount.toLocaleString(undefined, { maximumFractionDigits: 2 });

            updateRegionTotal(currentSelectedRegion);
            updateHistoryDisplayArea(); // 履歴表示を更新し、リナンバーをトリガー
        }

        function updateRegionTotal(region) {
            const products = detailData.get(region);
            let newTotal = 0;
            if (products) {
                newTotal = Array.from(products.values()).reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            }
            const regionTotalElement = document.getElementById('regionTotal');
            if (regionTotalElement) {
                regionTotalElement.innerText = `${newTotal.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2`;
            }
        }

        closeDetailModalButton.addEventListener('click', () => {
            detailModal.style.display = 'none';
            resetSelectedState();
        });

        window.addEventListener('click', (event) => {
            if (event.target === detailModal) {
                detailModal.style.display = 'none';
                resetSelectedState();
            }
        });

        const alternativeModal = document.getElementById('alternativeModal');
        const closeAlternativeModalButton = document.getElementById('closeAlternativeModal');
        const modalEstimateItemTitle = document.getElementById('modalEstimateItemTitle');
        const alternativeListDiv = document.getElementById('alternativeList');

        alternativeListDiv.addEventListener('click', (event) => {
            const rowElement = event.target.closest('.alt-item');
            if (rowElement) {
                handleAlternativeSelect(rowElement);
            }
        });

        function handleEstimateItemClick(linkElement) {
            console.log(`[handleEstimateItemClick] START - currentSelectedRegion: ${currentSelectedRegion}`);

            const region = linkElement.dataset.region;
            const productNameKey = linkElement.dataset.product;
            currentOriginalEstimateItemName = linkElement.dataset.originalEstimateItem; // e.g., 'スラブA'

            currentSelectedEstimateItemData = detailData.get(region).get(productNameKey); // クリックされた資材の現在のデータを設定

            currentOriginalProductData = initialDetailData.get(region).get(productNameKey); // 元々の資材データ
            currentProductNameKey = productNameKey; // 現在選択中の資材のキーを設定

            console.log('[handleEstimateItemClick] Clicked:', {
                region: currentSelectedRegion,
                productNameKey: productNameKey,
                originalEstimateItemNameUsedForSearch: currentOriginalEstimateItemName,
                currentSelectedEstimateItemData: currentSelectedEstimateItemData,
                currentOriginalProductData: currentOriginalProductData
            });

            if (!currentSelectedEstimateItemData) {
                console.error(`[handleEstimateItemClick] currentSelectedEstimateItemData is null/undefined for product: ${productNameKey}. Aborting.`);
                resetSelectedState();
                return;
            }

            let alternatives = alternativeComponentsData.get(currentOriginalEstimateItemName);

            // 元の項目を代替候補のリストの先頭に追加
            const originalItemAsAlternative = {
                altEstimateItemName: currentOriginalProductData.estimateItem, // 元の見積項目名
                materials: [{
                    name: currentOriginalProductData.currentAltName, // 元の資材名
                    unitPrice: currentOriginalProductData.unitPrice,
                    quantity: currentOriginalProductData.quantity,
                    unit: currentOriginalProductData.unit
                }]
            };

            if (!alternatives) {
                alternatives = []; // 代替候補がなければ空の配列を初期化
            }
            // 元の項目がすでに追加されていないか確認
            const isOriginalAlreadyPresent = alternatives.some(alt =>
                alt.altEstimateItemName === originalItemAsAlternative.altEstimateItemName &&
                alt.materials[0].name === originalItemAsAlternative.materials[0].name
            );

            if (!isOriginalAlreadyPresent) {
                alternatives.unshift(originalItemAsAlternative); // 先頭に追加
            }


            if (!alternatives || alternatives.length === 0) {
                console.warn(`[handleEstimateItemClick] No alternatives found for original estimate item: ${currentOriginalEstimateItemName}. Check 'alternativeComponentsData'.`);
                alert(`「${currentOriginalEstimateItemName}」に対する代替見積項目がありません。`);
                resetSelectedState();
                return;
            }

            modalEstimateItemTitle.innerText = `「${currentOriginalEstimateItemName}」の代替見積項目を選択`;

            // 代替項目選択モーダルのヘッダーの順序も変更
            let tableHtml = '<table><thead><tr><th>見積項目</th><th>資材名</th><th>原単位<br>(kg-CO2/単位)</th><th>数量</th><th>単位</th><th>排出量<br>(kg-CO2)</th></tr></thead><tbody>';

            alternatives.forEach((altEstimateItem, index) => {
                const totalAltItemAmount = altEstimateItem.materials.reduce((sum, mat) => sum + (mat.unitPrice * mat.quantity), 0);
                const firstMaterial = altEstimateItem.materials[0];

                tableHtml += `<tr class="alt-item"
                                data-alt-estimate-item-index="${index}"
                                data-original-estimate-item-name="${currentOriginalEstimateItemName}"
                                data-product-name-key="${productNameKey}">
                                <td>${altEstimateItem.altEstimateItemName}</td>
                                <td>${firstMaterial.name}</td>
                                <td class="alt-price-cell">${firstMaterial.unitPrice.toLocaleString(undefined, { maximumFractionDigits: 3 })}</td>
                                <td>${firstMaterial.quantity.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                                <td>${firstMaterial.unit}</td>
                                <td class="alt-price-cell">${totalAltItemAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                              </tr>`;
            });
            tableHtml += '</tbody></table>';
            alternativeListDiv.innerHTML = tableHtml;

            alternativeModal.style.display = 'block';
            console.log(`[handleEstimateItemClick] END - Alternative modal displayed.`);
        }

        function handleAlternativeSelect(selectedAltItemRow) {
            console.log(`[handleAlternativeSelect] START - currentSelectedRegion: ${currentSelectedRegion}, currentSelectedEstimateItemData:`, currentSelectedEstimateItemData, `currentOriginalEstimateItemName: ${currentOriginalEstimateItemName}`);

            const altEstimateItemIndex = parseInt(selectedAltItemRow.dataset.altEstimateItemIndex);
            const originalEstimateItemNameFromData = selectedAltItemRow.dataset.originalEstimateItemName;
            const productNameKey = selectedAltItemRow.dataset.productNameKey; // この変数名は現在の関数スコープで定義されるため、グローバルなcurrentProductNameKeyとは異なる

            console.log('[handleAlternativeSelect] Processing:', {
                region: currentSelectedRegion,
                productNameKey: productNameKey,
                originalEstimateItemNameFromData: originalEstimateItemNameFromData,
                altEstimateItemIndex: altEstimateItemIndex
            });

            if (!currentSelectedRegion || !currentSelectedEstimateItemData || !productNameKey || currentOriginalEstimateItemName !== originalEstimateItemNameFromData) {
                console.error('[handleAlternativeSelect] State mismatch or missing data. currentSelectedEstimateItemData:', currentSelectedEstimateItemData, 'Expected originalEstimateItemName:', originalEstimateItemNameFromData, 'Actual currentOriginalEstimateItemName:', currentOriginalEstimateItemName);
                alert('エラーが発生しました。再度お試しください。');
                resetSelectedState();
                return;
            }

            let alternativesForOriginalItem = alternativeComponentsData.get(originalEstimateItemNameFromData);
            // ここでも元の項目を追加するロジックを再度実行し、alternativesForOriginalItemが元の項目を含んでいることを保証
            const originalItemAsAlternative = {
                altEstimateItemName: currentOriginalProductData.estimateItem,
                materials: [{
                    name: currentOriginalProductData.currentAltName,
                    unitPrice: currentOriginalProductData.unitPrice,
                    quantity: currentOriginalProductData.quantity,
                    unit: currentOriginalProductData.unit
                }]
            };
            if (!alternativesForOriginalItem) {
                alternativesForOriginalItem = [];
            }
            const isOriginalAlreadyPresent = alternativesForOriginalItem.some(alt =>
                alt.altEstimateItemName === originalItemAsAlternative.altEstimateItemName &&
                alt.materials[0].name === originalItemAsAlternative.materials[0].name
            );
            if (!isOriginalAlreadyPresent) {
                alternativesForOriginalItem.unshift(originalItemAsAlternative);
            }


            if (!alternativesForOriginalItem || !alternativesForOriginalItem[altEstimateItemIndex]) {
                console.error('[handleAlternativeSelect] Selected alternative not found. Aborting.');
                resetSelectedState();
                return;
            }

            const selectedAltEstimateItem = alternativesForOriginalItem[altEstimateItemIndex];
            const newMaterial = selectedAltEstimateItem.materials[0];

            // オリジナルデータから「変更前」の情報を取得
            const originalProductData = initialDetailData.get(currentSelectedRegion).get(productNameKey);

            // 変更前の情報を記録 (常にoriginalProductDataから取得)
            const previousInfo = {
                estimateItem: originalProductData.estimateItem, // 見積項目も追加
                name: originalProductData.currentAltName,
                unitPrice: originalProductData.unitPrice,
                quantity: originalProductData.quantity,
                unit: originalProductData.unit,
                amount: originalProductData.unitPrice * originalProductData.quantity // オリジナルの排出量
            };

            // detailData 内の該当する資材データを更新
            currentSelectedEstimateItemData.estimateItem = selectedAltEstimateItem.altEstimateItemName;
            currentSelectedEstimateItemData.unitPrice = newMaterial.unitPrice;
            currentSelectedEstimateItemData.quantity = newMaterial.quantity;
            currentSelectedEstimateItemData.unit = newMaterial.unit;
            currentSelectedEstimateItemData.currentAltName = newMaterial.name;

            console.log('[handleAlternativeSelect] Updated product data in detailData:', currentSelectedEstimateItemData);

            // 同じregionとoriginalProductNameKeyを持つ既存の履歴を削除
            globalChangeLog = globalChangeLog.filter(log =>
                !(log.region === currentSelectedRegion && log.originalProductNameKey === productNameKey)
            );

            // グローバルな変更履歴に追加
            globalChangeLog.push({
                timestamp: new Date().toLocaleString(), // 日時を記録 (表示はしないがデータとして保持)
                type: 'alternative_replace', // 変更の種類 (表示はしないがデータとして保持)
                region: currentSelectedRegion,
                originalProductNameKey: productNameKey, // 履歴追跡のために元のプロダクトキーを保持
                previousEstimateItem: previousInfo.estimateItem,
                previousProductName: previousInfo.name,
                previousUnitPrice: previousInfo.unitPrice,
                previousQuantity: previousInfo.quantity,
                previousUnit: previousInfo.unit,
                previousAmount: previousInfo.amount, // 変更前の排出量
                currentEstimateItem: selectedAltEstimateItem.altEstimateItemName, // 見積項目も追加
                currentProductName: newMaterial.name,
                currentUnitPrice: newMaterial.unitPrice,
                currentQuantity: newMaterial.quantity,
                currentUnit: newMaterial.unit,
                currentAmount: newMaterial.unitPrice * newMaterial.quantity // 変更後の排出量
            });

            alternativeModal.style.display = 'none';
            displayDetailTable(currentSelectedRegion);
            updateHistoryDisplayArea(); // 履歴表示を更新し、リナンバーをトリガー
            resetSelectedState();
            console.log(`[handleAlternativeSelect] END - Alternative selected and state reset.`);
        }

        closeAlternativeModalButton.addEventListener('click', () => {
            alternativeModal.style.display = 'none';
            resetSelectedState();
        });

        window.addEventListener('click', (event) => {
            if (event.target === alternativeModal) {
                alternativeModal.style.display = 'none';
                resetSelectedState();
            }
        });

        function resetSelectedState() {
            currentSelectedRegion = null;
            currentSelectedEstimateItemData = null;
            currentOriginalEstimateItemName = null;
            currentOriginalProductData = null;
            currentProductNameKey = null; // リセット
            console.log('--- Selected state RESET. All related variables are null. ---');
        }

        const historyDisplayArea = document.getElementById('historyDisplayArea');
        const historyContentDiv = historyDisplayArea.querySelector('.history-content');

        function displayAllChangeHistory(targetDiv) {
            // 履歴番号の昇順でソート（今回は不要だが、順序を保証するため残す）
            const sortedHistory = [...globalChangeLog];

            if (sortedHistory.length === 0) {
                targetDiv.innerHTML = '<p>変更内容はありません。</p>';
                return;
            }

            // ヘッダーを調整（「単位」列を削除）
            let tableHtml = `<table>
                                <thead>
                                    <tr>
                                        <th rowspan="2">変更番号</th>
                                        <th rowspan="2">工程</th>
                                        <th colspan="2">見積項目</th>
                                        <th colspan="2">資材名</th>
                                        <th colspan="2">原単位<br>(kg-CO2/単位)</th>
                                        <th colspan="2">数量</th>
                                        <th colspan="2">排出量<br>(kg-CO2)</th>
                                    </tr>
                                    <tr>
                                        <th>変更前</th><th>変更後</th>
                                        <th>変更前</th><th>変更後</th>
                                        <th>変更前</th><th>変更後</th>
                                        <th>変更前</th><th>変更後</th>
                                        <th>変更前</th><th>変更後</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            sortedHistory.forEach((history, index) => { // indexを使用してリナンバー
                tableHtml += `<tr>
                                <td><div><span>${index + 1}</span></div></td>
                                <td><div><span class="previous-value">${history.region}</span></div></td>
                                <td><div><span class="previous-value">${history.previousEstimateItem}</span></div></td>
                                <td><div><span class="current-value">${history.currentEstimateItem}</span></div></td>
                                <td><div><span class="previous-value">${history.previousProductName}</span></div></td>
                                <td><div><span class="current-value">${history.currentProductName}</span></div></td>
                                <td><div><span class="previous-value">${history.previousUnitPrice.toLocaleString(undefined, { maximumFractionDigits: 3 })}</span></div></td>
                                <td><div><span class="current-value">${history.currentUnitPrice.toLocaleString(undefined, { maximumFractionDigits: 3 })}</span></div></td>
                                <td><div><span class="previous-value">${history.previousQuantity.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${history.previousUnit}</span></div></td>
                                <td><div><span class="current-value">${history.currentQuantity.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${history.currentUnit}</span></div></td>
                                <td><div><span class="previous-value">${(history.previousUnitPrice * history.previousQuantity).toLocaleString(undefined, { maximumFractionDigits: 2 })}</span></div></td>
                                <td><div><span class="current-value">${(history.currentUnitPrice * history.currentQuantity).toLocaleString(undefined, { maximumFractionDigits: 2 })}</span></div></td>
                            </tr>`;
            });
            tableHtml += '</tbody></table>';
            targetDiv.innerHTML = tableHtml;
        }

        function updateHistoryDisplayArea() {
            displayAllChangeHistory(historyContentDiv);
        }

        const comparisonChartModal = document.getElementById('comparisonChartModal');
        const closeComparisonChartModalButton = document.getElementById('closeComparisonChartModal');
        const showInitialChartButton = document.getElementById('showInitialChartButton');

        let initialPieChartInstance;
        let currentPieChartInstance;

        showInitialChartButton.addEventListener('click', () => {
            calculatePieChartData();
            drawInitialPieChartInModal();
            drawCurrentPieChartInModal();
            document.getElementById('initialModalTotal').innerText = initialGlobalTotalAmount.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' kg-CO2';
            const currentTotalForModal = pieChartDataValues.reduce((sum, value) => sum + value, 0);
            document.getElementById('currentModalTotal').innerText = currentTotalForModal.toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' kg-CO2';
            comparisonChartModal.style.display = 'block';
        });

        closeComparisonChartModalButton.addEventListener('click', () => {
            comparisonChartModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === comparisonChartModal) {
                comparisonChartModal.style.display = 'none';
            }
        });

        function drawInitialPieChartInModal() {
            const ctx = document.getElementById('initialPieChartCanvas').getContext('2d');
            if (initialPieChartInstance) { initialPieChartInstance.destroy(); }
            Chart.register(ChartDataLabels);
            initialPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: pieChartLabels,
                    datasets: [{
                        data: initialPieChartDataValues,
                        backgroundColor: pieChartBackgroundColors,
                        hoverOffset: hoverOffset,
                        datalabels: {
                            color: '#fff', font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                                const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                return `${percentage}%`;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawCurrentPieChartInModal() {
            const ctx = document.getElementById('currentPieChartCanvas').getContext('2d');
            if (currentPieChartInstance) { currentPieChartInstance.destroy(); }
            Chart.register(ChartDataLabels);
            currentPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: pieChartLabels,
                    datasets: [{
                        data: pieChartDataValues,
                        backgroundColor: pieChartBackgroundColors,
                        hoverOffset: hoverOffset,
                        datalabels: {
                            color: '#fff', font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, current) => sum + current, 0);
                                const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                return `${percentage}%`;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = (total === 0) ? 0 : ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg-CO2 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        updateChartButton.addEventListener('click', updateAllChartsAndDisplays);

        function updateAllChartsAndDisplays() {
            calculatePieChartData();
            const currentGlobalTotal = pieChartDataValues.reduce((sum, value) => sum + value, 0);
            pieChart.data.datasets[0].data = pieChartDataValues;
            pieChart.update();
            drawBarChart(initialGlobalTotalAmount, currentGlobalTotal);
            updateGlobalTotalAmount();
            detailModal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            calculateInitialPieChartData();
            initialGlobalTotalAmount = initialPieChartDataValues.reduce((sum, value) => sum + value, 0);
            drawPieChart();
            const currentGlobalTotal = pieChartDataValues.reduce((sum, value) => sum + value, 0);
            drawBarChart(initialGlobalTotalAmount, currentGlobalTotal);
            updateHistoryDisplayArea();
            resetSelectedState();
        });
    </script>
</body>
</html>